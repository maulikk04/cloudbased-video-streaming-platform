name: Deploy Core Backend Lambdas

on:
  push:
    branches: [ main ]


jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: 1. Checkout repository code
        uses: actions/checkout@v3

      - name: 2. Configure AWS Credentials
        # This provides the AWS CLI with temporary access using your GitHub secrets
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: 3. Set up Python Environment
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      # =================================================================
      # 4. DEPLOY UPLOAD SERVICE (Code and Configuration)
      # =================================================================
      - name: 4.1 Package and Deploy Upload Service
        run: |
          echo "Deploying UploadService..."
          
          # 1. INSTALL AND PACKAGE CODE
          pip install -r backend/upload_service/requirements.txt -t backend/upload_service/package
          cp backend/upload_service/lambda_function.py backend/upload_service/package/
          cd backend/upload_service/package
          zip -r ../deployment.zip .
          cd -
          
          # 2. UPDATE CONFIGURATION FIRST (Attempt to avoid conflict)
          aws lambda update-function-configuration \
            --function-name GeneratePresignedURL \
            --environment "Variables={RAWVIDEO_BUCKET_NAME=${{ secrets.RAWVIDEO_BUCKET_NAME}},REGION=${{ secrets.AWS_REGION}}}"

          # 3. UPDATE CODE
          aws lambda update-function-code \
            --function-name GeneratePresignedURL \
            --zip-file fileb://backend/upload_service/deployment.zip
          
          # 4. Clean up
          rm -rf backend/upload_service/package backend/upload_service/deployment.zip

      # =================================================================
      # 5. DEPLOY CONTENT LISTING SERVICE (Code and Configuration)
      # =================================================================
      - name: 5.1 Package and Deploy Content Listing Service
        run: |
          echo "Deploying ContentListingService..."
          
          # 1. INSTALL AND PACKAGE CODE
          pip install -r backend/contentListing_service/requirements.txt -t backend/contentListing_service/package
          cp backend/contentListing_service/lambda_function.py backend/contentListing_service/package/
          cd backend/contentListing_service/package
          zip -r ../deployment.zip .
          cd -
          
          # 2. UPDATE CONFIGURATION FIRST
          aws lambda update-function-configuration \
            --function-name ContentListingService \
            --environment "Variables={VIDEO_METADATA_TABLE_NAME=${{ secrets.VIDEO_METADATA_TABLE_NAME}},RAWVIDEO_BUCKET_NAME=${{ secrets.RAWVIDEO_BUCKET_NAME}},REGION=${{ secrets.AWS_REGION}}}"

          # 3. UPDATE CODE
          aws lambda update-function-code \
            --function-name ContentListingService \
            --zip-file fileb://backend/contentListing_service/deployment.zip
          
          # 4. Clean up
          rm -rf backend/contentListing_service/package backend/contentListing_service/deployment.zip

      # =================================================================
      # 6. DEPLOY PLAYBACK SERVICE (Code and Configuration)
      # =================================================================
      - name: 6.1 Package and Deploy Playback Service
        run: |
          echo "Deploying PlaybackService (requires complex dependencies)..."
          
          # 1. INSTALL AND PACKAGE CODE (using manylinux flags)
          pip install --platform manylinux2014_x86_64 --target backend/playback_service/package \
            --implementation cp --python-version 3.9 --only-binary=:all: -r backend/playback_service/requirements.txt
            
          cp backend/playback_service/lambda_function.py backend/playback_service/package/
          cd backend/playback_service/package
          zip -r ../deployment.zip .
          cd -
          
          # 2. UPDATE CONFIGURATION FIRST
          aws lambda update-function-configuration \
            --function-name userAuthenticate \
            --environment "Variables={KEY_PAIR_ID_PLAYBACK=${{ secrets.KEY_PAIR_ID_PLAYBACK}},CLOUDFRONT_DOMAIN=${{ secrets.CLOUDFRONT_DOMAIN}}}"

          # 3. UPDATE CODE
          aws lambda update-function-code \
            --function-name userAuthenticate \
            --zip-file fileb://backend/playback_service/deployment.zip
            
          # 4. Clean up
          rm -rf backend/playback_service/package backend/playback_service/deployment.zip

      # =================================================================
      # 7. DEPLOY CONTENT METADATA SERVICE (NEW)
      # =================================================================
      - name: 7.1 Package and Deploy Content Metadata Service
        run: |
          echo "Deploying ContentMetadataService..."
          
          # 1. Install dependencies and package code (boto3)
          pip install -r backend/content_metadata_service/requirements.txt -t backend/content_metadata_service/package
          cp backend/content_metadata_service/lambda_function.py backend/content_metadata_service/package/
          cd backend/content_metadata_service/package
          zip -r ../deployment.zip .
          cd -

          # 2. UPDATE CONFIGURATION FIRST
          aws lambda update-function-code \
            --function-name ContentMetaDataService \ # <--- REPLACE WITH YOUR EXACT AWS FUNCTION NAME
            --zip-file fileb://backend/content_metadata_service/deployment.zip
          
          # 3. Update Environment Variables (DynamoDB Table Name, Region)
          aws lambda update-function-configuration \
            --function-name ContentMetaDataService \ # <--- REPLACE WITH YOUR EXACT AWS FUNCTION NAME
            --environment "Variables={VIDEO_METADATA_TABLE_NAME=${{ secrets.VIDEO_METADATA_TABLE_NAME}},SQS_SEGMENTATION_QUEUE_URL=${{ secrets.SQS_SEGMENTATION_QUEUE_URL}}}"

          # 4. Clean up
          rm -rf backend/content_metadata_service/package backend/content_metadata_service/deployment.zip

      # =================================================================
      # 8. DEPLOY Manifest File Processor 
      # =================================================================
      - name: 8.1 Package and Deploy Content Metadata Service
        run: |
          echo "Deploying ContentMetadataService..."
          
          # 1. Install dependencies and package code (boto3)
          pip install -r backend/manifest_file_processor/requirements.txt -t backend/manifest_file_processor/package
          cp backend/manifest_file_processor/lambda_function.py backend/manifest_file_processor/package/
          cd backend/manifest_file_processor/package
          zip -r ../deployment.zip .
          cd -

          # 2. UPDATE CONFIGURATION FIRST
          aws lambda update-function-code \
            --function-name ManifestFileProcessor \ # <--- REPLACE WITH YOUR EXACT AWS FUNCTION NAME
            --zip-file fileb://backend/manifest_file_processor/deployment.zip
          
          # 3. Update Environment Variables (DynamoDB Table Name, Region)
          aws lambda update-function-configuration \
            --function-name ManifestFileProcessor \ # <--- REPLACE WITH YOUR EXACT AWS FUNCTION NAME
            --environment "Variables={DYNAMODB_TABLE_NAME=${{ secrets.DYNAMODB_TABLE_NAME}},PROCESSED_S3_BUCKET=${{ secrets.PROCESSED_S3_BUCKET}},CLOUDFRONT_DOMAIN=${{ secrets.CLOUDFRONT_DOMAIN}}}"

          # 4. Clean up
          rm -rf backend/manifest_file_processor/package backend/manifest_file_processor/deployment.zip

      # =================================================================
      # 9. DEPLOY Segmentation Service
      # =================================================================
      - name: 9.1 Package and Deploy Segmentation Service
        run: |
          echo "Deploying ContentMetadataService..."
          
          # 1. Install dependencies and package code (boto3)
          pip install -r backend/segmentation_service/requirements.txt -t backend/segmentation_service/package
          cp backend/segmentation_service/lambda_function.py backend/segmentation_service/package/
          cd backend/segmentation_service/package
          zip -r ../deployment.zip .
          cd -

          # 2. UPDATE CONFIGURATION FIRST
          aws lambda update-function-code \
            --function-name SegmentationService \ # <--- REPLACE WITH YOUR EXACT AWS FUNCTION NAME
            --zip-file fileb://backend/segmentation_service/deployment.zip
          
          # 3. Update Environment Variables (DynamoDB Table Name, Region)
          aws lambda update-function-configuration \
            --function-name SegmentationService \ # <--- REPLACE WITH YOUR EXACT AWS FUNCTION NAME
            --environment "Variables={TRANSCODING_JOB_QUEUE_URL=${{ secrets.TRANSCODING_JOB_QUEUE_URL}}}"

          # 4. Clean up
          rm -rf backend/segmentation_service/package backend/segmentation_service/deployment.zip



      - name: 10. Cleanup Local Artifacts
        run: |
          # This removes the local package/zip files created during deployment
          rm -rf backend/*/package backend/*/deployment.zip
      